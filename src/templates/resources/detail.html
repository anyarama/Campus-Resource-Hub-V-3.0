{% extends 'layout.html' %}
{% block title %}{{ resource.title }} | Campus Hub{% endblock %}
{% block page_heading %}{{ resource.title }}{% endblock %}
{% block content %}
<div class="detail-grid">
    <section class="card-surface p-5 resource-hero">
        <div>
            <p class="badge-pill mb-3">{{ resource.category }}</p>
            <h1 class="text-h1 mb-2">{{ resource.title }}</h1>
            <p class="text-body mb-0">{{ resource.summary or 'Detailed description coming soon.' }}</p>
        </div>
        <div class="resource-meta-list">
            {% if resource.location %}<span class="resource-meta-item">üìç {{ resource.location }}</span>{% endif %}
            {% if resource.capacity %}<span class="resource-meta-item">üë• Seats {{ resource.capacity }}</span>{% endif %}
            {% if resource.availability_notes %}<span class="resource-meta-item">üïí {{ resource.availability_notes }}</span>{% endif %}
            {% if resource.status %}<span class="resource-meta-item">Status: {{ resource.status|title }}</span>{% endif %}
        </div>
        <div class="resource-gallery">
            {% if resource.gallery %}
                {% for image in resource.gallery %}
                <img src="{{ url_for('static', filename=image) }}" class="img-fluid rounded mb-2" alt="Photo of {{ resource.title }}">
                {% endfor %}
            {% else %}
                <p class="mb-0">Upload photos to showcase this resource.</p>
            {% endif %}
        </div>

        <section>
            <h2 class="text-h3 mb-2">About this resource</h2>
            <p class="text-body">{{ resource.description or resource.summary or 'Add a detailed description to help students plan ahead.' }}</p>
        </section>

        <section>
            <h3 class="text-h4 mb-2">Booking notes</h3>
            <p class="text-body mb-0">{{ resource.availability_notes or 'See booking form for availability expectations and preparation details.' }}</p>
        </section>

        <section class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <p class="text-caption text-uppercase mb-1">Reviews</p>
                    <h3 class="text-h3 mb-0">Feedback</h3>
                </div>
                {% if current_user.is_authenticated %}
                <a class="btn btn-secondary-iu" href="{{ url_for('review.create', resource_id=resource.resource_id) }}">Leave feedback</a>
                {% endif %}
            </div>
            {% if rating_stats.total_reviews %}
            <p class="text-body mb-4">Average rating {{ '%.1f'|format(rating_stats.avg_rating) }} from {{ rating_stats.total_reviews }} reviews.</p>
            {% endif %}
            {% if reviews %}
            <div class="review-list">
                {% for review in reviews %}
                <article class="review-entry">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>{{ review.rating }} / 5</strong>
                        <span class="text-caption">{{ review.created_at }}</span>
                    </div>
                    <p class="text-body mb-2">{{ review.comment or 'No written feedback.' }}</p>
                    {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.user_id == review.reviewer_id) %}
                    <form method="post" action="{{ url_for('review.delete', review_id=review.review_id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button class="btn btn-ghost-iu text-danger p-0" type="submit">Remove</button>
                    </form>
                    {% endif %}
                </article>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted mb-0">No reviews yet.</p>
            {% endif %}
        </section>

        {% if related %}
        <section class="mt-4">
            <h3 class="text-h4 mb-3">Similar resources</h3>
            <div class="resource-grid">
                {% for peer in related %}
                <article class="resource-card">
                    <span class="badge-pill mb-2">{{ peer.category }}</span>
                    <h4 class="text-h4 mb-1">{{ peer.title }}</h4>
                    <p class="text-body">{{ peer.summary[:120] }}{% if peer.summary|length > 120 %}&hellip;{% endif %}</p>
                    <div class="resource-footer">
                        <a href="{{ url_for('resource.detail', resource_id=peer.resource_id) }}" class="btn btn-primary-iu">View</a>
                    </div>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </section>

    <aside class="resource-quick-card card-surface p-5">
        <div class="d-flex flex-column gap-3">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('booking.request_booking', resource_id=resource.resource_id) }}" class="btn btn-primary-iu">Request booking</a>
            <a href="{{ url_for('message.start', owner_id=resource.owner_id, resource_id=resource.resource_id) }}" class="btn btn-secondary-iu">Message owner</a>
            {% else %}
            <a href="{{ url_for('auth.login') }}" class="btn btn-primary-iu">Sign in to book</a>
            {% endif %}
            {% if current_user.is_authenticated and current_user.user_id == resource.owner_id and current_user.role in ['staff', 'admin'] %}
            <a href="{{ url_for('resource.edit', resource_id=resource.resource_id) }}" class="btn btn-ghost-iu">Edit listing</a>
            {% endif %}
        </div>
        <div class="quick-stat">
            <span>Location</span>
            <strong>{{ resource.location or 'TBD' }}</strong>
        </div>
        <div class="quick-stat">
            <span>Capacity</span>
            <strong>{{ resource.capacity or '‚Äî' }}</strong>
        </div>
        <div class="quick-stat">
            <span>Status</span>
            <strong>{{ resource.status|title if resource.status else 'Published' }}</strong>
        </div>
        <div>
            <p class="text-caption text-uppercase mb-1">Owner</p>
            <p class="text-body mb-0">Use the message link above to coordinate with the listing owner.</p>
        </div>
    </aside>
</div>
{% endblock %}
